# Cache Me Outside

Laurent Chauvin | October 27, 2022

## Resources

https://guyinatuxedo.github.io/29-tcache/tcache_explanation/index.html

https://infosecwriteups.com/heap-exploitation-journey-1-tcache-attack-5b38fb0c19b0

## Progress

```
nc mercury.picoctf.net 17612 

wget https://mercury.picoctf.net/static/8e71d30964dc6344e76c961d02772d34/heapedit
wget https://mercury.picoctf.net/static/8e71d30964dc6344e76c961d02772d34/Makefile
wget https://mercury.picoctf.net/static/8e71d30964dc6344e76c961d02772d34/libc.so.6
```

Ghidra headedit.

It seems flag.txt is read and stored in variable 'local_58'.

The Adress asked by the program is stored in 'local_a8' and the value in 'local_a9'.

By specifying the right adress and the right value, it might be possible to buffer overflow on eip and get the flag (somehow).

```assembly
*local_98 = 0x73746172676e6f43;     // Spells: Congrats
local_98[1] = 0x662072756f592021;   // Spells: ! Your f
local_98[2] = 0x203a73692067616c;   // Spells: lag is:
*(undefined *)(local_98 + 3) = 0;   
strcat((char *)local_98,local_58);  // Concatenate flag
```

strcat will store the result in local_98.


Found this code too:

```assembly
local_88 = (undefined8 *)malloc(0x80);       // Allocate 128 bytes
*local_88 = 0x5420217972726f53;              // Spells: Sorry! T
local_88[1] = 0x276e6f7720736968;            // Spells: This won'
local_88[2] = 0x7920706c65682074;            // Spells: t help y
*(undefined4 *)(local_88 + 3) = 0x203a756f;  // Spells: ou:
 *(undefined *)((long)local_88 + 0x1c) = 0;
 strcat((char *)local_88,(char *)&local_78);
```

```
local_78 = 0x2073692073696874;               // Spells: This is
local_70 = 0x6d6f646e61722061;               // Spells: a random
local_68 = 0x2e676e6972747320;               // Spells: string.
```

This is the visible part of the code:

```assembly
puts("You may edit one byte in the program.");
printf("Address: ");
__isoc99_scanf(&DAT_00400b48,&local_a8);
printf("Value: ");
__isoc99_scanf(&DAT_00400b53,&local_a9);
*(undefined *)((long)local_a8 + (long)local_a0) = local_a9;
local_80 = malloc(0x80);
puts((char *)((long)local_80 + 0x10));

```

We can see there is a puts. If we can control what is output, we can force to output flag (local_98).

If adress of local_80 can be found, it can be manipulated to point to flag - 0x10.

```assembly
                     **************************************************************
                     *                          FUNCTION                          *
                     **************************************************************
                     undefined main()
     undefined         AL:1           <RETURN>
     undefined8        Stack[-0x10]:8 local_10                                XREF[2]:     00400828(W), 
                                                                                           00400a68(R)  
     undefined1        Stack[-0x58]:1 local_58                                XREF[2]:     00400863(*), 
                                                                                           00400916(*)  
     undefined1        Stack[-0x60]:1 local_60                                XREF[1]:     0040089e(W)  
     undefined8        Stack[-0x68]:8 local_68                                XREF[1]:     0040089a(W)  
     undefined8        Stack[-0x70]:8 local_70                                XREF[1]:     0040088c(W)  
     undefined8        Stack[-0x78]:8 local_78                                XREF[2]:     00400888(W), 
                                                                                           00400986(*)  
     undefined8        Stack[-0x80]:8 local_80                                XREF[2]:     00400a4f(W), 
                                                                                           00400a53(R)  
     undefined8        Stack[-0x88]:8 local_88                                XREF[4]:     0040094a(W), 
                                                                                           0040094e(R), 
                                                                                           0040098a(R), 
                                                                                           004009a8(R)  
     undefined8        Stack[-0x90]:8 local_90                                XREF[2]:     00400855(W), 
                                                                                           0040085c(R)  
     undefined8        Stack[-0x98]:8 local_98                                XREF[5]:     004008c3(W), 
                                                                                           004008d4(R), 
                                                                                           004008e2(R), 
                                                                                           0040091a(R), 
                                                                                           00400999(R)  
     undefined8        Stack[-0xa0]:8 local_a0                                XREF[4]:     004008a2(W), 
                                                                                           004008ca(R), 
                                                                                           004008db(W), 
                                                                                           00400a32(R)  
     undefined4        Stack[-0xa4]:4 local_a4                                XREF[3]:     004008ad(W), 
                                                                                           0040092c(RW), 
                                                                                           00400933(R)  
     undefined4        Stack[-0xa8]:4 local_a8                                XREF[3]:     004009b4(W), 
                                                                                           004009e2(*), 
                                                                                           00400a29(R)  
     undefined1        Stack[-0xa9]:1 local_a9                                XREF[3]:     004009be(W), 
                                                                                           00400a0e(*), 
                                                                                           00400a3c(R)  
     undefined4        Stack[-0xbc]:4 local_bc                                XREF[1]:     00400812(W)  
     undefined8        Stack[-0xc8]:8 local_c8                                XREF[1]:     00400818(W)  
                     main                                            XREF[5]:     Entry Point(*), 
                                                                                  _start:0040073d(*), 
                                                                                  _start:0040073d(*), 00400b7c, 
                                                                                  00400c20(*)  
00400807 55              PUSH       RBP

```

local_80 seems to be on Stack[-0x80].

```
free(local_98);
free(local_88);
```

local_98 seems to be free before the 'puts', but should still be in cache.

The idea here seems to be to poison the cache to force 'local_98' to be written at 'local_80' location, which is outputed in the puts. [cf Resources]

## Flag

